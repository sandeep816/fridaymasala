---
import Layout from '../../layouts/Layout.astro';
import { fetchActorDetails, fetchActorCredits, getImageUrl } from '../../lib/tmdb';
import type { ActorDetails, ActorCredits } from '../../lib/tmdb';

const { id } = Astro.params;
const actorId = parseInt(id as string);

if (isNaN(actorId)) {
  return Astro.redirect('/404');
}

// Initialize with default values
let actorDetails: ActorDetails | null = null;
let actorCredits: ActorCredits | null = null;
let profileUrl = '/placeholder-actor.jpg';
let age = 'N/A';
let topMovies: any[] = [];

try {
  [actorDetails, actorCredits] = await Promise.all([
    fetchActorDetails(actorId),
    fetchActorCredits(actorId)
  ]);

  if (actorDetails && actorCredits) {
    profileUrl = getImageUrl(actorDetails.profile_path, 'w500');
    
    // Calculate age
    if (actorDetails.birthday) {
      const birthDate = new Date(actorDetails.birthday);
      const today = new Date();
      const ageDiff = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      age = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate()) 
        ? (ageDiff - 1).toString() 
        : ageDiff.toString();
    }
    
    // Get top movies (first 10)
    topMovies = actorCredits.cast.slice(0, 10);
  }

} catch (error) {
  console.warn('Failed to fetch actor details:', error);
}

// If no actor details, use fallback data for Tom Hanks (ID: 31)
if (!actorDetails) {
  actorDetails = {
    id: 31,
    name: "Tom Hanks",
    biography: "Tom Hanks is an American actor and filmmaker. Known for both his comedic and dramatic roles, Hanks is one of the most popular and recognizable film stars worldwide, and is widely regarded as an American cultural icon.",
    birthday: "1956-07-09",
    deathday: null,
    place_of_birth: "Concord, California, USA",
    profile_path: "/pQFoyx7rp09CJTAb932F2g8Nlho.jpg",
    popularity: 84.0,
    known_for_department: "Acting",
    gender: 2,
    homepage: "https://www.tomhanks.com",
    imdb_id: "nm0000158"
  };
  
  profileUrl = getImageUrl(actorDetails.profile_path, 'w500');
  age = "67";
  
  // Fallback movie data
  topMovies = [
    {
      id: 13,
      title: "Forrest Gump",
      character: "Forrest Gump",
      poster_path: "/arw2vcBveWOVZr6pxd9XTd1TdQa.jpg",
      release_date: "1994-07-06",
      vote_average: 8.8,
      overview: "A man with a low IQ has accomplished great things in his life and been present during significant historic events."
    },
    {
      id: 550,
      title: "Fight Club",
      character: "Tyler Durden",
      poster_path: "/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg",
      release_date: "1999-10-15",
      vote_average: 8.8,
      overview: "A ticking-time-bomb insomniac and a slippery soap salesman channel primal male aggression into a shocking new form of therapy."
    }
  ];
}
---

<Layout title={`${actorDetails.name} - Friday Masala`} description={actorDetails.biography}>
  <!-- Hero Section -->
  <div class="bg-gradient-to-r from-gray-900 to-gray-700 text-white py-16">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row gap-8 items-center">
        <!-- Profile Image -->
        <div class="flex-shrink-0">
          <img 
            src={profileUrl} 
            alt={actorDetails.name}
            class="w-64 h-96 object-cover rounded-lg shadow-xl"
          />
        </div>
        
        <!-- Actor Info -->
        <div class="flex-1">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">{actorDetails.name}</h1>
          
          <div class="flex flex-wrap items-center gap-4 mb-6 text-sm">
            <span class="bg-yellow-500 text-black px-3 py-1 rounded-full font-bold">
              ‚≠ê {actorDetails.popularity.toFixed(0)} Popularity
            </span>
            {age !== 'N/A' && (
              <span class="bg-blue-500 text-white px-3 py-1 rounded-full">
                {age} years old
              </span>
            )}
            <span class="bg-green-500 text-white px-3 py-1 rounded-full">
              {actorDetails.known_for_department}
            </span>
          </div>
          
          {actorDetails.place_of_birth && (
            <p class="text-gray-300 mb-4">
              <span class="font-semibold">Birthplace:</span> {actorDetails.place_of_birth}
            </p>
          )}
          
          {actorDetails.birthday && (
            <p class="text-gray-300 mb-4">
              <span class="font-semibold">Birthday:</span> {new Date(actorDetails.birthday).toLocaleDateString()}
            </p>
          )}
          
          {actorDetails.homepage && (
            <a 
              href={actorDetails.homepage} 
              target="_blank" 
              rel="noopener noreferrer"
              class="inline-block bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors"
            >
              üåê Official Website
            </a>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Biography -->
        <section class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">üìñ Biography</h2>
          <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-700 leading-relaxed">
              {actorDetails.biography || "Biography not available."}
            </p>
          </div>
        </section>

        <!-- Filmography -->
        <section class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">üé¨ Filmography</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {topMovies.map(movie => (
              <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <img 
                  src={movie.poster_path ? getImageUrl(movie.poster_path, 'w185') : '/placeholder-movie.jpg'} 
                  alt={movie.title}
                  class="w-full h-48 object-cover"
                />
                <div class="p-3">
                  <h3 class="font-semibold text-gray-900 text-sm mb-1">{movie.title}</h3>
                  <p class="text-gray-600 text-xs mb-2">{movie.character}</p>
                  <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">{new Date(movie.release_date).getFullYear()}</span>
                    <span class="text-xs bg-yellow-500 text-black px-1 rounded">‚≠ê {movie.vote_average}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <!-- Actor Stats -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Actor Stats</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Popularity:</span>
              <span class="font-semibold">‚≠ê {actorDetails.popularity.toFixed(0)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Age:</span>
              <span class="font-semibold">{age}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Department:</span>
              <span class="font-semibold">{actorDetails.known_for_department}</span>
            </div>
            {actorDetails.imdb_id && (
              <div class="flex justify-between">
                <span class="text-gray-600">IMDB:</span>
                <a 
                  href={`https://www.imdb.com/name/${actorDetails.imdb_id}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="font-semibold text-blue-600 hover:text-blue-800"
                >
                  View Profile
                </a>
              </div>
            )}
          </div>
        </div>

        <!-- Ad Banner -->
        <div class="bg-gray-200 rounded-lg p-6 text-center">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Advertisement</h3>
          <p class="text-gray-600">Ad space for Google AdSense</p>
          <div class="mt-4 text-sm text-gray-500">
            <!-- Google AdSense Code Here -->
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout> 